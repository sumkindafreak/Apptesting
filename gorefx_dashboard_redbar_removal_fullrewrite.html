
<!DOCTYPE html>

<html lang="en">
<head>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AlzaSyCbBK1hwavHkKopd6cycSXOc8QQQhVPWYU",
    authDomain: "hauntsync-forum-b99d2.firebaseapp.com",
    projectId: "hauntsync-forum-b99d2",
    storageBucket: "hauntsync-forum-b99d2.appspot.com",
    messagingSenderId: "1039278802707",
    appId: "1:1039278802707:web:hauntsyncdemo123"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>GoreFX Dashboard</title>
<style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #000; color: white; }
    .sidebar { width: 250px; position: fixed; top: 0; bottom: 0; left: 0; background: #111; padding: 1rem; overflow-y: auto; transition: transform 0.3s ease; z-index: 100; }
    .sidebar.collapsed { transform: translateX(-100%); }
    .sidebar h2 { color: #f33; margin-bottom: 1rem; }
    .sidebar a { display: block; color: white; padding: 0.5rem 0; text-decoration: none; border-bottom: 1px solid #333; cursor: pointer; }
    .sidebar a:hover { background: #222; }
    .main-content { margin-left: 260px; padding: 2rem; transition: margin-left 0.3s ease; }
    .main-content.full-width { margin-left: 10px; }
    .glitch { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(transparent 0px, rgba(255,255,255,0.03) 2px, transparent 4px); pointer-events: none; mix-blend-mode: overlay; z-index: 999; animation: flicker 0.15s infinite; }
    @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
    h1, h2 { color: #f33; }
    .section { display: none; margin-bottom: 3rem; }
    .section.active { display: block; }
    .diag-box, .setting-box, .help-box { background: #111; padding: 1rem; margin: 0.5rem 0; border-left: 4px solid #f33; border-radius: 4px; }
    .diag-box h3, .setting-box h3, .help-box h3 { margin: 0 0 0.5rem 0; color: #fff; }
    .btn { background: #f33; border: none; color: #fff; padding: 0.5rem 1rem; margin: 0.25rem; cursor: pointer; border-radius: 4px; }
    .slider { width: 100%; margin: 0.5rem 0; }
    textarea { width: 100%; padding: 0.5rem; border-radius: 4px; background: #222; color: white; border: 1px solid #444; }
    .toggle-btn { position: fixed; top: 10px; left: 10px; background: #f33; color: #fff; border: none; padding: 10px; cursor: pointer; z-index: 101; }
  
:root {
  --bg-color: #000;
  --text-color: #fff;
  --accent-color: #f33;
  --button-bg: #f33;
}
body.theme-default {
  --bg-color: #000;
  --text-color: #fff;
  --accent-color: #f33;
  --button-bg: #f33;
}
body.theme-neon {
  --bg-color: #000;
  --text-color: #00fafa;
  --accent-color: #f0f;
  --button-bg: #0ff;
}
body.theme-necro {
  --bg-color: #0a0a0a;
  --text-color: #dddddd;
  --accent-color: #aa55ff;
  --button-bg: #552288;
}
body.theme-crt {
  --bg-color: #001100;
  --text-color: #33ff33;
  --accent-color: #66ff66;
  --button-bg: #004d00;
}
body.theme-inferno {
  --bg-color: #220000;
  --text-color: #ffcc00;
  --accent-color: #ff4500;
  --button-bg: #ff5500;
}
body {
  background-color: var(--bg-color);
  color: var(--text-color);
}
.btn {
  background: var(--button-bg);
}

.slider-group {
  margin-bottom: 1rem;
  display: flex;
  flex-direction: column;
}
.slider-group label {
  margin-bottom: 0.25rem;
  font-weight: bold;
}
.slider-group input[type="range"] {
  width: 100%;
}

:root {
  --bg-color: #000;
  --text-color: #fff;
  --accent-color: #f33;
  --button-bg: #f33;
}
body.theme-default {
  --bg-color: #000;
  --text-color: #fff;
  --accent-color: #f33;
  --button-bg: #f33;
}
body.theme-neon {
  --bg-color: #000;
  --text-color: #00fafa;
  --accent-color: #f0f;
  --button-bg: #0ff;
}
body.theme-necro {
  --bg-color: #0a0a0a;
  --text-color: #dddddd;
  --accent-color: #aa55ff;
  --button-bg: #552288;
}
body.theme-crt {
  --bg-color: #001100;
  --text-color: #33ff33;
  --accent-color: #66ff66;
  --button-bg: #004d00;
}
body.theme-inferno {
  --bg-color: #220000;
  --text-color: #ffcc00;
  --accent-color: #ff4500;
  --button-bg: #ff5500;
}
body {
  background-color: var(--bg-color);
  color: var(--text-color);
}
.btn {
  background: var(--button-bg);
  color: var(--text-color);
}

.glitch-flicker {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: repeating-linear-gradient(
    transparent 0px, rgba(255,255,255,0.05) 2px, transparent 4px
  );
  pointer-events: none;
  mix-blend-mode: overlay;
  z-index: 9999;
  animation: flick-glitch 0.3s ease-out forwards;
}
@keyframes flick-glitch {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 0; }
}
.ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  animation: rippleEffect 0.6s linear;
  pointer-events: none;
  z-index: 1000;
}
@keyframes rippleEffect {
  from { transform: scale(0); opacity: 0.6; }
  to { transform: scale(2); opacity: 0; }
}
.quick-fx-panel {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #111;
  border: 1px solid var(--accent-color);
  border-radius: 8px;
  padding: 0.5rem;
  z-index: 1000;
}
.quick-fx-panel button {
  margin: 0.25rem;
}

#fxEditorModal input, #fxEditorModal select, #fxEditorModal textarea {
  display: block;
  width: 100%;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  background: #222;
  color: white;
  border: 1px solid #444;
  border-radius: 4px;
}

#fxEditorModal textarea,
#fxEditorModal input,
#fxEditorModal select {
  width: 100%;
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  border-radius: 5px;
  background: #222;
  color: white;
  border: 1px solid #444;
}

.fx-btn {
  position: relative;
  background: #333;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  transition: transform 0.1s ease, background 0.3s;
}
.fx-btn:hover {
  background: #555;
}
.fx-btn:active {
  transform: scale(0.95);
}
.fx-btn.loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 18px;
  height: 18px;
  border: 2px solid white;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  transform: translate(-50%, -50%);
}
@keyframes spin {
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<link href="manifest.json" rel="manifest"/>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(() => {
      console.log("Service Worker Registered");
    });
  }
</script>
<style>
body.splash-active {
  overflow: hidden;
}
</style><style>
@keyframes glitch {
  0% { opacity: 1; transform: scale(1) translate(0, 0); }
  20% { opacity: 0.8; transform: scale(1.02) translate(-2px, 1px); }
  40% { opacity: 0.6; transform: scale(0.98) translate(1px, -2px); }
  60% { opacity: 0.9; transform: scale(1.01) translate(-1px, 1px); }
  80% { opacity: 0.7; transform: scale(1.03) translate(2px, -1px); }
  100% { opacity: 1; transform: scale(1) translate(0, 0); }
}
.glitch-logo {
  animation: glitch 1s infinite;
}

@keyframes typing {
  from { width: 0 }
  to { width: 100% }
}
.loading-text::after {
  content: "Loading GoreFX...";
  display: inline-block;
  overflow: hidden;
  white-space: nowrap;
  border-right: 0.1em solid red;
  animation: typing 3s steps(20) 1 forwards;
}
</style><style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #0a0a0a;
      color: #f4f4f4;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 300px;
      background: #1c1c1c;
      padding: 20px;
      border-right: 2px solid #5c5c5c;
    }
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .fx-button {
      display: inline-block;
      background: #5c5c5c;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
    }
    .delete-btn, .edit-btn {
      position: absolute;
      top: 2px;
      width: 16px;
      height: 16px;
      font-size: 12px;
      line-height: 14px;
      text-align: center;
      border-radius: 50%;
      cursor: pointer;
      color: white;
    }
    .delete-btn {
      right: 2px;
      background: #8B0000;
    }
    .edit-btn {
      left: 2px;
      background: #444;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 4px;
    }
  </style>
<script>
    let editingIndex = null;

    function renderButtons(layout) {
      const container = document.getElementById('fxContainer');
      container.innerHTML = '<h2>Live FX Buttons</h2>';
      layout.forEach((fx, i) => {
        const btn = document.createElement('button');
        btn.className = 'fx-button';
        btn.style.background = fx.color;
        btn.innerText = fx.name;
        btn.onclick = () => alert('Sending: ' + fx.command);

        const del = document.createElement('div');
        del.className = 'delete-btn';
        del.innerText = '×';
        del.onclick = (e) => {
          e.stopPropagation();
          layout.splice(i, 1);
          localStorage.setItem('fxLayout', JSON.stringify(layout));
          renderButtons(layout);
        };

        const edit = document.createElement('div');
        edit.className = 'edit-btn';
        edit.innerText = '✎';
        edit.onclick = (e) => {
          e.stopPropagation();
          document.getElementById('fxName').value = fx.name;
          document.getElementById('fxCommand').value = fx.command;
          document.getElementById('fxColor').value = fx.color;
          editingIndex = i;
        };

        btn.appendChild(edit);
        btn.appendChild(del);
        container.appendChild(btn);
      });
    }

    function addFX() {
      const name = document.getElementById('fxName').value;
      const command = document.getElementById('fxCommand').value;
      const color = document.getElementById('fxColor').value;
      if (!name || !command) return;

      let layout = JSON.parse(localStorage.getItem('fxLayout') || '[]');
      if (editingIndex !== null) {
        layout[editingIndex] = { name, command, color };
        editingIndex = null;
      } else {
        layout.push({ name, command, color });
      }
      localStorage.setItem('fxLayout', JSON.stringify(layout));
      renderButtons(layout);
      document.getElementById('fxName').value = '';
      document.getElementById('fxCommand').value = '';
    }

    function saveLayout() {
      alert('Layout saved to browser!');
    }

    function exportLayout() {
      const layout = localStorage.getItem('fxLayout');
      const blob = new Blob([layout], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'fx_layout.json';
      a.click();
    }

    function importLayout(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const layout = JSON.parse(e.target.result);
          localStorage.setItem('fxLayout', JSON.stringify(layout));
          renderButtons(layout);
        } catch (e) {
          alert('Import failed');
        }
      };
      reader.readAsText(file);
    }

    window.onload = () => {
      const layout = JSON.parse(localStorage.getItem('fxLayout') || '[]');
      renderButtons(layout);
    }
  </script>
</head>
<body>

<div style="position: absolute; top: 10px; right: 10px; z-index: 999;">
  <button onclick="toggleFullscreen()" style="padding: 6px 12px; font-size: 14px;">Toggle Fullscreen</button>
</div>

<div id="splashScreen" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: black url('splash.png') center center no-repeat;
  background-size: contain;
  z-index: 9999;background-color: black;display: flex; align-items: center; justify-content: center;pointer-events: all;">
<div style="text-align: center;">
<img alt="GoreFX" class="glitch-logo" src="splash.png" style="max-width: 70vw; max-height: 40vh;"/>
<div class="loading-text" style="margin-top: 1rem; font-family: monospace; font-size: 1.2rem; color: red;"></div>
</div>
</div>
<button class="toggle-btn" onclick="toggleSidebar()">☰</button><button class="toggle-btn" onclick="toggleFullScreen()" style="left: 60px;">⛶</button>
<div class="sidebar" id="sidebar">
<h2>GoreFX</h2>
<a onclick="showSection('dashboard')">Dashboard</a>
<a onclick="showSection('showlibrary')">Show Library</a>
<a onclick="showSection('livecontrols')">Live Controls</a>
<a onclick="showSection('timeline')">Timeline Editor</a>
<a onclick="showSection('audio')">Audio Manager</a>
<a onclick="showSection('community')">Community</a>
<a onclick="showSection('settings')">Settings</a>
<a onclick="showSection('diagnostics')">Diagnostics</a>
<a onclick="showSection('help')">Help</a>
<a onclick="showSection('customCommands')">Custom Commands</a><a href="#" onclick="showSection('support')">Support</a><a href="#" onclick="showSection('about')">About</a></div>
<div class="main-content" id="main"><div id="clockDisplay" style="position: fixed; top: 10px; right: 10px; color: #f33; font-size: 1rem; z-index: 1000;"></div>
<div class="glitch"></div>
<div class="section active" id="dashboard">
<h1>Dashboard</h1>
<p>Welcome to the GoreFX Dashboard</p>
</div>
<div class="section" id="settings">
<h2 style="color: var(--accent-color); border-bottom: 1px solid var(--accent-color); padding-bottom: 0.5rem;">Settings</h2>
<div class="setting-box">
<label for="theme-select" style="color: var(--accent-color); font-weight: bold; display: block; margin-bottom: 0.5rem;">
      Choose Theme:
    </label>
<select id="theme-select" onchange="applyTheme(this.value)" style="background: var(--bg-color); color: var(--text-color); border: 1px solid var(--accent-color); padding: 0.5rem; width: 100%;">
<option value="theme-default">Default</option>
<option value="theme-neon">Neon Glitch</option>
<option value="theme-necro">Dark Necro</option>
<option value="theme-crt">Retro CRT</option>
<option value="theme-inferno">Inferno Ember</option>
</select>
</div>
<div class="slider-group" style="margin-top: 2rem;">
<label for="vibrateToggle" style="color: var(--accent-color); font-weight: bold;">
        Enable Phone Vibration
      </label>
<input id="vibrateToggle" onchange="localStorage.setItem('vibrateEnabled', this.checked)" type="checkbox"/>
</div>
</div>
<div class="section" id="diagnostics">
<h2>System Diagnostics</h2>
<div class="diag-box"><h3>Voltage:</h3><p>12.3V</p></div>
<div class="diag-box"><h3>PWR OK:</h3><p>Yes</p></div>
<div class="diag-box"><h3>SD Card:</h3><p>Mounted</p></div>
<div class="diag-box"><h3>WiFi Status:</h3><p>Connected - IP 192.168.4.1</p></div>
<div class="diag-box"><h3>NeoPixels Group 1:</h3><p>Status: Active</p></div>
<div class="diag-box"><h3>Relay Controls:</h3>
<button class="btn" onclick="sendCommand('RELAY_1_ON')">Relay 1 ON</button>
<button class="btn" onclick="sendCommand('RELAY_1_OFF')">Relay 1 OFF</button>
</div>
</div>
<div class="section" id="help">
<h2>Help &amp; Support</h2>
<div class="help-box">
<h3>Contact Us</h3>
<p>Email: <a href="mailto:showduino38@gmail.com" style="color:#f33">showduino38@gmail.com</a></p>
<p>Website: <a href="https://show-duino.com" style="color:#f33" target="_blank">https://show-duino.com</a></p>
</div>
</div>
<div class="section" id="livecontrols">
<h2>Live Controls</h2>
<div class="fx-group">
<h3>Lantern FX</h3>
<button class="btn" onclick="sendCommand('TRIGGER:FLICKER')">Flicker</button>
<button class="btn" onclick="sendCommand('TRIGGER:GLOW')">Glow</button>
<button class="btn" onclick="sendCommand('TRIGGER:PULSE')">Pulse</button>
<button class="btn" onclick="sendCommand('TRIGGER:HELLFIRE')">Hellfire</button>
</div>
<div class="fx-group" style="margin-top: 1rem;">
<h3>R3 Terminal</h3>
<button class="btn" onclick="sendCommand('TRIGGER:TIMEFLICK')">Time Flicker</button>
<button class="btn" onclick="sendCommand('TRIGGER:GLITCH')">Glitch</button>
<button class="btn" onclick="sendCommand('TRIGGER:SHOCK')">Shock</button>
</div>
<hr style="margin: 2rem 0; border: 1px solid var(--accent-color);"/>
<h3>Real-Time FX Sliders</h3>
<div class="slider-group">
<label for="volA">Player A Volume</label>
<input id="volA" max="255" min="0" oninput="sendCommand('PLAYER_A_VOL:' + this.value)" type="range" value="128"/>
</div>
<div class="slider-group">
<label for="volB">Player B Volume</label>
<input id="volB" max="255" min="0" oninput="sendCommand('PLAYER_B_VOL:' + this.value)" type="range" value="128"/>
</div>
<div class="slider-group">
<label for="pix1">NeoPixel Line 1 Brightness</label>
<input id="pix1" max="255" min="0" oninput="sendCommand('PIXEL_LINE1_BRIGHT:' + this.value)" type="range" value="255"/>
</div>
<div class="slider-group">
<label for="pix2">NeoPixel Line 2 Brightness</label>
<input id="pix2" max="255" min="0" oninput="sendCommand('PIXEL_LINE2_BRIGHT:' + this.value)" type="range" value="255"/>
</div>
<div class="slider-group">
<label for="pix3">NeoPixel Line 3 Brightness</label>
<input id="pix3" max="255" min="0" oninput="sendCommand('PIXEL_LINE3_BRIGHT:' + this.value)" type="range" value="255"/>
</div>
<div class="slider-group">
<label for="pix4">NeoPixel Line 4 Brightness</label>
<input id="pix4" max="255" min="0" oninput="sendCommand('PIXEL_LINE4_BRIGHT:' + this.value)" type="range" value="255"/>
</div>
</div>
<script>
  let fxList = ["TRIGGER_R3", "START_SHOW", "FLASH_LIGHTS"];
  function renderFx() {
    const grid = document.getElementById("fxGrid");
    grid.innerHTML = "";
    fxList.forEach((fx, i) => {
      const div = document.createElement("div");
      div.className = "fx-button";

      const span = document.createElement("span");
      span.textContent = fx;
      span.ondblclick = () => editFx(i);

      const editIcon = document.createElement("span");
      editIcon.textContent = "✏️";
      editIcon.className = "icon";
      editIcon.onclick = () => editFx(i);

      const delIcon = document.createElement("span");
      delIcon.textContent = "🗑️";
      delIcon.className = "icon";
      delIcon.onclick = () => deleteFx(i);

      div.onclick = () => sendCommand(fx);
      div.appendChild(span);
      div.appendChild(editIcon);
      div.appendChild(delIcon);
      grid.appendChild(div);
    });
  }

  function addFx() {
    const newFx = prompt("Enter new FX command:");
    if (newFx) {
      fxList.push(newFx.toUpperCase());
      renderFx();
    }
  }

  function deleteFx(index) {
    if (confirm("Delete FX '" + fxList[index] + "' ?")) {
      fxList.splice(index, 1);
      renderFx();
    }
  }

  function editFx(index) {
    const newName = prompt("Rename FX:", fxList[index]);
    if (newName) {
      fxList[index] = newName.toUpperCase();
      renderFx();
    }
  }

  window.addEventListener("load", function () {
    if (document.getElementById("fxGrid")) renderFx();
  });

function applyTheme(themeName) {
  document.body.className = themeName;
  localStorage.setItem("selectedTheme", themeName);
}
window.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("selectedTheme");
  if (saved) applyTheme(saved);
});

function isVibrateOn() {
  return localStorage.getItem("vibrateEnabled") === "true";
}
</script>
<div class="section" id="timeline">
<div style="margin-bottom: 1rem;">
<label style="color: var(--accent-color); font-weight: bold;">Load Show File (.shdo)</label><br/>
<input accept=".shdo,application/json" onchange="loadTimelineFile(event)" type="file"/>
</div>
<h2>Timeline Editor</h2>
<div class="setting-box">
<div style="margin-top:1rem;">
<label>Load Show File:</label>
<select id="fileList" onchange="loadTimelineFile(this.value)">
<option value="">Select .shdo file</option>
<option value="coffin.shdo">coffin.shdo</option>
<option value="zombie_attack.shdo">zombie_attack.shdo</option>
</select>
</div>
<div id="timelineGrid" style="margin-bottom: 1rem;"></div>
<button class="btn" onclick="addTimelineStep()">+ Add Step</button>
<button class="btn" onclick="clearTimeline()">Clear All</button>
<button class="btn" onclick="exportTimeline()">Export .shdo</button>
</div>
<pre id="timelineOutput" style="margin-top:1rem; background:#222; padding:1rem; max-height:200px; overflow-y:auto;"></pre><div id="timelineWrapper" style="background:#111; border:1px solid #444; overflow-x:scroll; margin-top:1rem;">
</div><h3 style="color:#f33;">FX Timeline Visual Editor</h3><div id="timelineEditor">
<label>Scene Name: <input id="sceneName" style="width:50%;" type="text"/></label>
<div id="sceneSteps" style="margin:0.5rem 0;"></div>
<button class="btn" onclick="saveScene()">Save Scene</button>
<button class="btn" onclick="deleteScene()">Delete Scene</button>
<button class="btn" onclick="triggerCustomScene()">Play Scene</button>
<div style="margin-top:0.5rem;">
<label>Load Saved Scene:</label>
<select id="savedScenesDropdown" onchange="loadScene(this.value)">
<option value="">-- Select a Scene --</option>
</select>
</div>
</div><h2 style="color:#ff3333;">Timeline Editor</h2><h3 style="margin-top:1rem;">Visual Timeline</h3><div id="visualTimeline" style="margin-top:0.5rem; background:#222; height:120px; overflow-x:auto; border:1px solid #444; position:relative;"></div><button class="btn" onclick="startPlayback()">▶ Play</button><button class="btn" onclick="exportTimelineJSON()">Export</button><button class="btn" onclick="importTimelineJSON()">Import</button><input accept=".shdo" id="shdoFileInput" style="display:none;" type="file"/></div>
<script>
      let timelineSteps = [];

      function addTimelineStep() {
        timelineSteps.push({ fx: "", delay: 1000 });
        renderTimeline();
      }

      function clearTimeline() {
        if (confirm("Clear all timeline steps?")) {
          timelineSteps = [];
          renderTimeline();
        }
      }

      function renderTimeline() {
        const grid = document.getElementById("timelineGrid");
        grid.innerHTML = "";
        timelineSteps.forEach((step, i) => {
          const row = document.createElement("div");
          row.className = "timeline-row";
          row.style.marginBottom = "0.5rem";

          const fxInput = document.createElement("input");
          fxInput.type = "text";
          fxInput.value = step.fx;
          fxInput.placeholder = "FX Name";
          fxInput.oninput = (e) => timelineSteps[i].fx = e.target.value;
          fxInput.style.marginRight = "10px";
          fxInput.style.padding = "0.5rem";
          fxInput.style.background = "#222";
          fxInput.style.color = "#fff";
          fxInput.style.border = "1px solid #444";
          fxInput.style.borderRadius = "4px";

          const delayInput = document.createElement("input");
          delayInput.type = "number";
          delayInput.value = step.delay;
          delayInput.oninput = (e) => timelineSteps[i].delay = parseInt(e.target.value);
          delayInput.style.padding = "0.5rem";
          delayInput.style.background = "#222";
          delayInput.style.color = "#fff";
          delayInput.style.border = "1px solid #444";
          delayInput.style.borderRadius = "4px";

          row.appendChild(fxInput);
          row.appendChild(delayInput);
          grid.appendChild(row);
        });
      }

      function exportTimeline() {
        const output = { steps: timelineSteps };
        const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "timeline.shdo";
        link.click();
      }

      window.addEventListener("load", () => {
        if (document.getElementById("timelineGrid")) renderTimeline();
      });
    
function isVibrateOn() {
  return localStorage.getItem("vibrateEnabled") === "true";
}
</script>
<div class="section" id="community">
<h2>HauntSync Community</h2>
<button class="btn" onclick="signUpEmail()">Sign Up with Email</button><p>Subscribe and log in to access full dashboard features.</p>
<div id="firebase-user-info" style="margin-bottom:1rem;"><p><i>You are not logged in.</i></p></div>
<button class="btn" onclick="loginEmail()">Login with Email</button>
<p style="margin-top:1rem;"><strong>Membership:</strong> £5/month</p>
<img alt="PayPal QR" src="/images/paypal_qr_code.png" style="width:150px;"/>
<p>Scan to subscribe and unlock full access.</p>
</div>
<div class="section" id="customCommands">
<h2>Custom Commands</h2>
<textarea id="customCommandInput" placeholder="Enter Showduino command..." rows="3" style="width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 0.5rem; margin-bottom: 1rem;"></textarea>
<button class="btn" onclick="sendCustomCommand()">Send Command</button>
<h3 style="margin-top: 1rem;">Command Reference</h3>
<div style="max-height: 250px; overflow-y: auto; background: #111; border: 1px solid #333; padding: 0.5rem;">
<code style="white-space: pre-wrap; display: block;">
PIXELS_ALL_ON  
PIXELS_ALL_OFF  
PIXELS_LINE1_ON  
PIXELS_LINE1_OFF  
PIXELS_LINE2_ON  
PIXELS_LINE2_OFF  
PIXELS_LINE3_ON  
PIXELS_LINE3_OFF  
PIXELS_LINE4_ON  
PIXELS_LINE4_OFF

RELAY1_ON  
RELAY1_OFF  
RELAY2_ON  
RELAY2_OFF  
RELAY3_ON  
RELAY3_OFF  
RELAY4_ON  
RELAY4_OFF  
RELAY5_ON  
RELAY5_OFF  
RELAY6_ON  
RELAY6_OFF  
RELAY7_ON  
RELAY7_OFF  
RELAY8_ON  
RELAY8_OFF

STATUS_REQUEST  
SELF_TEST  
DIAGNOSTICS_GET  
SHOW_START  
SHOW_STOP  
SOUND_PLAY_A  
SOUND_PLAY_B  
SOUND_STOP_ALL
    </code>
</div>
</div>
<div class="section" id="showlibrary">
<h2 style="color: var(--accent-color);">Show Library</h2>
<div>
<button class="btn" onclick="simulateSDShows()">Load Shows from SD Card</button>
<input accept=".shdo" id="upload-show" onchange="handleShowUpload(event)" style="margin-top: 1rem;" type="file"/>
</div>
<div id="sd-show-list" style="margin-top: 1rem;">
<h3>SD Card Shows:</h3>
<ul id="show-files-sd">  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
</div>
<div id="upload-show-list" style="margin-top: 2rem;">
<h3>Uploaded From Phone:</h3>
<ul id="show-files-uploaded">  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
</div>
</div>
<div class="section" id="audio">
<h2 style="color: var(--accent-color);">Audio Manager</h2>
<div style="display: flex; gap: 2rem; flex-wrap: wrap;">
<div style="flex: 1;">
<h3>MP3 Player A</h3>
<button onclick="requestAudioList('A')">Load from SD</button>
<input accept=".mp3,.wav" onchange="handleUserAudioUpload(event, 'A')" style="margin: 0.5rem 0;" type="file"/>
<ul id="audio-list-a">  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
</div>
<div style="flex: 1;">
<h3>MP3 Player B</h3>
<button onclick="requestAudioList('B')">Load from SD</button>
<input accept=".mp3,.wav" onchange="handleUserAudioUpload(event, 'B')" style="margin: 0.5rem 0;" type="file"/>
<ul id="audio-list-b">  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="about">
<h2 style="color: var(--accent-color);">About Showduino</h2>
<p>
<strong>What is Showduino?</strong><br/>
    Showduino is a DIY show control system designed for immersive horror experiences, escape rooms, interactive theatre, art installations, and prop sequencing. It combines ESP32, Arduino, touchscreens, SD cards, audio modules, and UI overlays to give you full creative control over your haunt or venue.
  </p>
<p style="margin-top: 1rem;">
<strong>Legal Disclaimer:</strong><br/>
    Showduino is a non-commercial, enthusiast-grade control platform not certified for use in medical, safety-critical, or life-support applications. Use of this system is entirely at your own risk. You must ensure that all electrical, structural, and physical implementations of this system are legally compliant and safe for use in your country or venue.
    <br/><br/>
    The creators of Showduino and GoreFX assume no responsibility for:
    <ul>
<li>Injury or property damage caused by improper installation or use</li>
<li>Loss of data or malfunctions from corrupted SD cards</li>
<li>Possession by demons, hauntings, or accidental summoning rituals</li>
  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
    Use responsibly and keep an emergency priest on standby.
  </p>
<p style="margin-top: 1rem;">
<strong>Roadmap:</strong>
<ul>
<li>ESP32-based Timeline syncing with drag-and-drop editor</li>
<li>WebSocket real-time control and diagnostics</li>
<li>DMX Universe Expansion</li>
<li>Modular add-on system for props and interactive puzzles</li>
<li>Audio file management and MP3 sync with visual waveform editing</li>
<li>Encrypted prop triggers and OTA updates</li>
  <li><a href="#" onclick="showPanel('customizer')">Customizer</a></li>
</ul>
</p>
<p style="margin-top: 1rem;">
<strong>Contact:</strong><br/>
    Email: <a href="mailto:showduino38@gmail.com">showduino38@gmail.com</a><br/>
    Support / Ideas / Collaborations welcome.
  </p>
<p style="margin-top: 1rem;">
<strong>Support the Project:</strong><br/>
    If you like what you see, consider buying me a coffee:<br/>
<a href="https://buymeacoffee.com/showduino" target="_blank">https://buymeacoffee.com/showduino</a>
</p>
<p style="margin-top: 1rem; font-style: italic;">
    Built with love, fear, and solder burns.<br/>
    — Created by Toby Brandon
  </p>
</div>
<div class="section" id="support">
<h2>Support Request</h2>
<form action="https://formspree.io/f/xldbkdla" class="fs-form" method="POST" target="_top">
<fieldset>
<legend class="fs-fieldset-title">Contact Information</legend>
<div class="fs-field">
<label class="fs-label" for="full-name">Full Name</label>
<input class="fs-input" id="full-name" name="full-name" placeholder="Enter your full name" required=""/>
</div>
<div class="fs-field">
<label class="fs-label" for="email-address">Email Address</label>
<input class="fs-input" id="email-address" name="email-address" placeholder="Enter your email address" required=""/>
</div>
</fieldset>
<fieldset>
<legend class="fs-fieldset-title">Support Request Details</legend>
<div class="fs-field">
<label class="fs-label" for="support-type">Type of Support Needed</label>
<select class="fs-select" id="support-type" name="support-type" required="">
<option value="technical-issue">Technical Issue</option>
<option value="billing-inquiry">Billing Inquiry</option>
<option value="account-help">Account Help</option>
<option value="general-question">General Question</option>
</select>
</div>
<div class="fs-field">
<label class="fs-label" for="subject-of-request">Subject of Request</label>
<input class="fs-input" id="subject-of-request" name="subject-of-request" placeholder="Enter the subject of your request" required=""/>
</div>
<div class="fs-field col-span-full">
<label class="fs-label" for="detailed-description">Detailed Description</label>
<textarea class="fs-textarea" id="detailed-description" name="detailed-description" placeholder="Provide a detailed description" required=""></textarea>
</div>
<div class="fs-field">
<label class="fs-label" for="product-or-service">Product or Service Related To</label>
<input class="fs-input" id="product-or-service" name="product-or-service" placeholder="Enter the related product or service"/>
</div>
<div class="fs-field">
<label class="fs-label" for="attachment">Attachment (Links only)</label>
<input class="fs-input" id="attachment" name="attachment" placeholder="Link to Google Drive, Dropbox, etc."/>
</div>
<div class="fs-field">
<label class="fs-label" for="device-browser-info">Device / Browser Info</label>
<input class="fs-input" id="device-browser-info" name="device-browser-info" placeholder="e.g., iPhone 14, Chrome v112"/>
</div>
<div class="fs-field">
<label class="fs-label" for="best-time-to-reach">Best Time to Reach You</label>
<input class="fs-input" id="best-time-to-reach" name="best-time-to-reach" placeholder="e.g., Weekdays 2-5 PM"/>
</div>
<div class="fs-button-group">
<button class="fs-button" type="submit">Submit</button>
</div>
</fieldset>
</form>
</div>
</div>
<script>
    function sendCommand(cmd) {
      console.log("COMMAND:", cmd);
    }
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main');
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('full-width');
    }
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
  

function updateClock() {
  const now = new Date();
  const timeString = now.toLocaleTimeString();
  const el = document.getElementById('clockDisplay');
  if (el) el.textContent = timeString;
}
setInterval(updateClock, 1000);
updateClock();

function sendCustomCommand() {
  const input = document.getElementById('customCommandInput');
  if (!input.value.trim()) return alert('Please enter a command first.');
  sendCommand(input.value.trim());
  alert('Command sent: ' + input.value.trim());
  input.value = '';
}


// --- Showduino Ping ---
window.addEventListener("load", () => {
  fetch("/ping")
    .then(res => res.ok ? console.log("Showduino detected") : throwError())
    .catch(() => {
      alert("No Showduino found! Loading Builder Mode...");
      showSection('community');
    });
});

function throwError() {
  throw new Error("Showduino not responding");
}

// --- FX Sound + Flash ---
function playFxFeedback() {
  const beep = new Audio('lurkin.wav');
  beep.play();
  document.body.style.backgroundColor = "#f00";
  setTimeout(() => document.body.style.backgroundColor = "", 100);
}

function sendCommand(cmd) {
  console.log("COMMAND:", cmd);
  playFxFeedback();
}

// --- Timeline FX Enhancements ---
function renderTimeline() {
  const grid = document.getElementById("timelineGrid");
  grid.innerHTML = "";
  timelineSteps.forEach((step, i) => {
    const row = document.createElement("div");
    row.className = "timeline-row";
    row.style.marginBottom = "0.5rem";
    row.draggable = true;
    row.ondragstart = (e) => e.dataTransfer.setData("text/plain", i);
    row.ondragover = (e) => e.preventDefault();
    row.ondrop = (e) => {
      const from = parseInt(e.dataTransfer.getData("text"));
      const to = i;
      const temp = timelineSteps[from];
      timelineSteps.splice(from, 1);
      timelineSteps.splice(to, 0, temp);
      renderTimeline();
    };

    const fxInput = document.createElement("input");
    fxInput.type = "text";
    fxInput.value = step.fx;
    fxInput.placeholder = "FX Name";
    fxInput.oninput = (e) => timelineSteps[i].fx = e.target.value;
    fxInput.style.marginRight = "10px";
    fxInput.style.padding = "0.5rem";
    fxInput.style.background = "#222";
    fxInput.style.color = "#fff";
    fxInput.style.border = "1px solid #444";
    fxInput.style.borderRadius = "4px";

    const delayInput = document.createElement("input");
    delayInput.type = "number";
    delayInput.value = step.delay;
    delayInput.oninput = (e) => {
      const raw = parseInt(e.target.value);
      timelineSteps[i].delay = Math.round(raw / 500) * 500;
      delayInput.value = timelineSteps[i].delay;
    };
    delayInput.style.padding = "0.5rem";
    delayInput.style.background = "#222";
    delayInput.style.color = "#fff";
    delayInput.style.border = "1px solid #444";
    delayInput.style.borderRadius = "4px";

    row.appendChild(fxInput);
    row.appendChild(delayInput);
    grid.appendChild(row);
  });
}

// --- Show Library Loader (Mocked for now) ---
function loadTimelineFile(filename) {
  alert("Mock loading: " + filename + " — Real ESP32 SD integration coming soon.");
}

function isVibrateOn() {
  return localStorage.getItem("vibrateEnabled") === "true";
}

function isVibrateOn() {
  return localStorage.getItem("vibrateEnabled") === "true";
}

document.addEventListener('click', function(e) {
  if (isVibrateOn()) {
    const tag = (e.target.tagName || '').toLowerCase();
    const exclude = ['input', 'textarea', 'select'];
    if (!exclude.includes(tag)) {
      navigator.vibrate(50);
    }
  }
});

function loadTimelineFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw "Invalid format";

      const timeline = document.getElementById("timeline-steps");
      if (timeline) timeline.innerHTML = "";

      data.forEach((step, i) => {
        const div = document.createElement("div");
        div.className = "timeline-step";
        div.innerHTML = '<strong>Step ' + (i + 1) + '</strong><br>' +
          'Prop: ' + step.prop + '<br>' +
          'FX: ' + step.fx + '<br>' +
          'Delay: ' + step.delay + 'ms<br><hr>';
        timeline.appendChild(div);
      });

      alert("Show file loaded successfully!");
    } catch (err) {
      alert("Failed to load timeline: " + err);
    }
  };
  reader.readAsText(file);
}
</script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("splash-active");

  const splash = document.getElementById("splashScreen");
  const totalDelay = 4000; // Wait 4 seconds before fade

  setTimeout(() => {
    splash.style.transition = "opacity 1s ease";
    splash.style.opacity = 0;

    setTimeout(() => {
      splash.remove();
      document.body.classList.remove("splash-active");
    }, 1000);
  }, totalDelay);
});

let currentFxName = "";

function openFxSettings(fxName) {
  currentFxName = fxName;
  document.getElementById("fxSettingsModal").style.display = "block";
  const saved = JSON.parse(localStorage.getItem("fxSettings") || "{}");
  const fx = saved[fxName] || { duration: 1000, intensity: 5 };
  document.getElementById("fxDuration").value = fx.duration;
  document.getElementById("fxIntensity").value = fx.intensity;
}

function closeFxSettings() {
  document.getElementById("fxSettingsModal").style.display = "none";
}

function saveFxSettings() {
  const duration = parseInt(document.getElementById("fxDuration").value, 10);
  const intensity = parseInt(document.getElementById("fxIntensity").value, 10);
  const saved = JSON.parse(localStorage.getItem("fxSettings") || "{}");
  saved[currentFxName] = { duration, intensity };
  localStorage.setItem("fxSettings", JSON.stringify(saved));
  closeFxSettings();
  logFX(`Updated settings for ${currentFxName}: ${duration}ms, intensity ${intensity}`);
}

document.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("contextmenu", e => {
    e.preventDefault();
    openFxSettings(btn.textContent.trim());
  });
});

function sendFxCommand(fxName, settings = {}) {
  const payload = {
    fx: fxName,
    duration: settings.duration || 1000,
    intensity: settings.intensity || 5
  };

  fetch("http://esp32.local/fx", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  }).then(res => {
    if (!res.ok) throw new Error("ESP32 error");
    logFX(`Sent FX command to Showduino: ${fxName}`);
  }).catch(err => {
    logFX(`Error sending FX to ESP32: ${err.message}`);
  });
}

document.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("click", () => {
    const fxName = btn.textContent.trim();
    const saved = JSON.parse(localStorage.getItem("fxSettings") || "{}");
    const settings = saved[fxName] || { duration: 1000, intensity: 5 };
    sendFxCommand(fxName, settings);
  });
});

function saveFxSettings() {
  const duration = parseInt(document.getElementById("fxDuration").value, 10);
  const intensity = parseInt(document.getElementById("fxIntensity").value, 10);
  const saved = JSON.parse(localStorage.getItem("fxSettings") || "{}");
  saved[currentFxName] = { duration, intensity };
  localStorage.setItem("fxSettings", JSON.stringify(saved));
  closeFxSettings();
  logFX(`Updated settings for ${currentFxName}: ${duration}ms, intensity ${intensity}`);
  sendFxCommand(currentFxName, { duration, intensity });
}

function addSceneStep(fx = "", duration = 1000, intensity = 5, delay = 0) {
  const step = document.createElement("div");
  step.innerHTML = `
    FX: <input class='fx' value='${fx}' style='width:80px;' />
    Duration: <input type='number' class='duration' value='${duration}' style='width:70px;' />
    Intensity: <input type='number' class='intensity' value='${intensity}' style='width:60px;' />
    Delay: <input type='number' class='delay' value='${delay}' style='width:60px;' />
    <button onclick='this.parentElement.remove()'>X</button>
  `;
  document.getElementById("sceneSteps").appendChild(step);
}

function saveScene() {
  const name = document.getElementById("sceneName").value.trim();
  if (!name) return alert("Name your scene.");
  const steps = [];
  document.querySelectorAll("#sceneSteps > div").forEach(row => {
    steps.push({
      fx: row.querySelector(".fx").value,
      duration: parseInt(row.querySelector(".duration").value),
      intensity: parseInt(row.querySelector(".intensity").value),
      delay: parseInt(row.querySelector(".delay").value)
    });
  });
  const allScenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  allScenes[name] = steps;
  localStorage.setItem("customScenes", JSON.stringify(allScenes));
  logFX(`Saved scene: ${name}`);
}

function triggerCustomScene() {
  const name = document.getElementById("sceneName").value.trim();
  const scenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  const steps = scenes[name];
  if (!steps) return alert("Scene not found.");
  let delay = 0;
  steps.forEach(step => {
    delay += step.delay || 0;
    setTimeout(() => {
      sendFxCommand(step.fx, { duration: step.duration, intensity: step.intensity });
    }, delay);
    delay += step.duration;
  });
}

function loadScene(name) {
  if (!name) return;
  const scenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  const steps = scenes[name];
  if (!steps) return;
  document.getElementById("sceneSteps").innerHTML = "";
  document.getElementById("sceneName").value = name;
  steps.forEach(s => addSceneStep(s.fx, s.duration, s.intensity, s.delay));
}

function updateSceneDropdown() {
  const dropdown = document.getElementById("savedScenesDropdown");
  dropdown.innerHTML = "<option value=''>-- Select a Scene --</option>";
  const scenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  Object.keys(scenes).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    dropdown.appendChild(opt);
  });
}

window.addEventListener("DOMContentLoaded", updateSceneDropdown);

function deleteScene() {
  const name = document.getElementById("sceneName").value.trim();
  if (!name) return alert("Enter scene name to delete.");
  const all = JSON.parse(localStorage.getItem("customScenes") || "{}");
  if (!all[name]) return alert("Scene not found.");
  if (confirm("Delete scene '" + name + "'?")) {
    delete all[name];
    localStorage.setItem("customScenes", JSON.stringify(all));
    updateSceneDropdown();
    document.getElementById("sceneSteps").innerHTML = "";
    document.getElementById("sceneName").value = "";
    logFX(`Deleted scene: ${name}`);
  }
}

function renderVisualTimeline() {
  const sceneName = document.getElementById("sceneName").value.trim();
  const scenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  const steps = scenes[sceneName];
  if (!steps) return;

  const container = document.getElementById("visualTimeline");
  container.innerHTML = "";

  let currentX = 0;
  steps.forEach((step, index) => {
    const block = document.createElement("div");
    const delay = step.delay || 0;
    const width = Math.max(50, step.duration / 10);
    const color = getFxColor(step.fx);

    currentX += delay / 10;

    block.style.position = "absolute";
    block.style.left = `${currentX}px`;
    block.style.top = "10px";
    block.style.width = `${width}px`;
    block.style.height = "40px";
    block.style.background = color;
    block.style.border = "1px solid #000";
    block.style.textAlign = "center";
    block.style.color = "white";
    block.style.fontSize = "12px";
    block.style.lineHeight = "40px";
    block.innerText = step.fx;
    container.appendChild(block);

    currentX += width;
  });
}

function getFxColor(fx) {
  fx = fx.toUpperCase();
  if (fx.includes("PIXEL")) return "#00bcd4";
  if (fx.includes("SHOCK")) return "#e91e63";
  if (fx.includes("HELLFIRE")) return "#ff5722";
  if (fx.includes("FLICKER")) return "#ffeb3b";
  return "#9c27b0";
}

// Add render call into loadScene and saveScene
const _originalLoadScene = loadScene;
loadScene = function(name) {
  _originalLoadScene(name);
  renderVisualTimeline();
};

const _originalSaveScene = saveScene;
saveScene = function() {
  _originalSaveScene();
  renderVisualTimeline();
};

window.addEventListener("DOMContentLoaded", () => {
  const demo = {
    "fx": "HELLFIRE",
    "duration": 2000,
    "intensity": 7,
    "delay": 0
  };
  const demo2 = {
    "fx": "SHOCK",
    "duration": 1500,
    "intensity": 5,
    "delay": 1000
  };
  const scenes = JSON.parse(localStorage.getItem("customScenes") || "{}");
  if (!scenes["Demo Scene"]) {
    scenes["Demo Scene"] = [demo, demo2];
    localStorage.setItem("customScenes", JSON.stringify(scenes));
  }
  updateSceneDropdown();
  loadScene("Demo Scene");
});

const ESP32_BASE_URL = "http://192.168.4.1";

function logFX(message) {
  const log = document.getElementById("fxLogPanel") || console;
  const p = document.createElement("p");
  p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  log.prepend ? log.prepend(p) : console.log(message);
}

function sendFxCommand(fxName, settings = {}) {
  const payload = {
    fx: fxName,
    duration: settings.duration || 1000,
    intensity: settings.intensity || 5
  };

  logFX(`Sending: ${JSON.stringify(payload)}`);

  fetch(`${ESP32_BASE_URL}/fx`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error("ESP32 returned error");
    return res.text();
  })
  .then(responseText => {
    logFX(`✅ Success: ${responseText}`);
  })
  .catch(err => {
    logFX(`❌ Error: ${err.message}`);
  });
}

document.querySelectorAll(".fx-btn").forEach(btn => {
  const fx = btn.textContent.trim().toUpperCase();
  btn.onclick = () => {
    btn.classList.add("loading");
    sendFxCommand(fx);
    setTimeout(() => btn.classList.remove("loading"), 1000);
  };
});

    const qDur = document.getElementById("quickFxDuration");
    const qInt = document.getElementById("quickFxIntensity");
    const qDurLabel = document.getElementById("quickFxDurationLabel");
    const qIntLabel = document.getElementById("quickFxIntensityLabel");
    const soundOn = document.getElementById("quickFxSoundToggle");
    const fxBeep = document.getElementById("quickFxBeep");

    qDur.oninput = () => qDurLabel.textContent = qDur.value;
    qInt.oninput = () => qIntLabel.textContent = qInt.value;

    document.querySelectorAll("#quickFxPanel button.btn").forEach(btn => {
      btn.onclick = () => {
        const fx = btn.textContent.trim();
        if (soundOn.checked) fxBeep.play().catch(() => {});
        sendFxCommand(fx, { duration: parseInt(qDur.value), intensity: parseInt(qInt.value) });
      };
    });
    
let fxBlocks = [];
let timelineCanvas = document.getElementById("timelineCanvas");
let timeRuler = document.getElementById("timeRuler");

function addFXBlock(fx = "FX", delay = 0, duration = 1000) {
  const block = document.createElement("div");
  block.className = "fx-block";
  block.textContent = fx;
  block.style.position = "absolute";
  block.style.top = "20px";
  block.style.left = delay + "px";
  block.style.width = duration / 10 + "px";
  block.style.height = "60px";
  block.style.padding = "5px";
  block.style.borderRadius = "5px";
  block.style.fontSize = "12px";
  block.style.textAlign = "center";
  block.style.background = getFxColor(fx);
  block.dataset.fx = fx;
  block.dataset.delay = delay;
  block.dataset.duration = duration;

  block.onclick = () => {
    const newFx = prompt("Edit FX name:", fx);
    const newDur = parseInt(prompt("Duration (ms):", duration), 10);
    const newDel = parseInt(prompt("Delay (px):", delay), 10);
    if (newFx && newDur && !isNaN(newDur) && !isNaN(newDel)) {
      block.textContent = newFx;
      block.style.width = newDur / 10 + "px";
      block.style.left = newDel + "px";
      block.style.background = getFxColor(newFx);
      block.dataset.fx = newFx;
      block.dataset.delay = newDel;
      block.dataset.duration = newDur;
    }
  };

  timelineCanvas.appendChild(block);
  fxBlocks.push({ fx, delay, duration });
}

function getFxColor(fx) {
  fx = fx.toUpperCase();
  if (fx.includes("PIXEL")) return "#0ff";
  if (fx.includes("HELLFIRE")) return "#f33";
  if (fx.includes("SHOCK")) return "#ff0";
  if (fx.includes("FLICKER")) return "#fa0";
  return "#9c27b0";
}

function buildTimeRuler() {
  timeRuler.innerHTML = "";
  for (let i = 0; i < 2000; i += 100) {
    const mark = document.createElement("div");
    mark.className = "ruler-mark";
    mark.style.position = "absolute";
    mark.style.top = "0";
    mark.style.left = `${i}px`;
    mark.style.height = "100%";
    mark.style.width = "1px";
    mark.style.background = "#555";
    timeRuler.appendChild(mark);

    const label = document.createElement("div");
    label.style.position = "absolute";
    label.style.left = `${i + 2}px`;
    label.style.top = "2px";
    label.style.color = "#aaa";
    label.style.fontSize = "10px";
    label.textContent = `${i / 1000}s`;
    timeRuler.appendChild(label);
  }
}

function exportTimelineJSON() {
  const data = Array.from(document.querySelectorAll(".fx-block")).map(b => ({
    fx: b.dataset.fx,
    delay: parseInt(b.style.left),
    duration: parseInt(b.style.width) * 10
  }));
  document.getElementById("timelineOutput").textContent = JSON.stringify(data, null, 2);

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "scene.shdo";
  link.click();
}

function importTimelineJSON() {
  document.getElementById("shdoFileInput").click();
}

document.getElementById("shdoFileInput").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const json = JSON.parse(e.target.result);
    json.forEach(fx => addFXBlock(fx.fx, fx.delay, fx.duration));
  };
  reader.readAsText(file);
});

function startPlayback() {
  const playhead = document.getElementById("playhead");
  playhead.style.left = "0px";

  let maxEnd = 0;
  document.querySelectorAll(".fx-block").forEach(b => {
    const d = parseInt(b.style.left) + parseInt(b.style.width);
    if (d > maxEnd) maxEnd = d;
  });

  playhead.style.transition = `left ${maxEnd / 1000}s linear`;
  playhead.style.left = maxEnd + "px";

  setTimeout(() => {
    playhead.style.transition = "none";
    playhead.style.left = "0px";
  }, maxEnd);
}

timelineCanvas.ondragover = e => e.preventDefault();
timelineCanvas.ondrop = e => {
  e.preventDefault();
  const offset = e.offsetX;
  const snapped = Math.round(offset / 50) * 50;
  addFXBlock("FX", snapped, 1000);
};

buildTimeRuler();

document.addEventListener("DOMContentLoaded", () => {
  const demoTimeline = [
    { fx: "HELLFIRE", delay: 0, duration: 1500 },
    { fx: "SHOCK", delay: 600, duration: 1000 },
    { fx: "PIXEL BURST", delay: 1600, duration: 1200 }
  ];
  demoTimeline.forEach(item => addFXBlock(item.fx, item.delay, item.duration));
});

const ESP32_ENDPOINT = "http://192.168.4.1/fx";  // change if needed

function triggerFXLive(fxName, duration = 1000, intensity = 5) {
  const payload = { fx: fxName, duration, intensity };
  console.log("Sending FX:", payload);
  fetch(ESP32_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(res => res.text()).then(console.log).catch(console.error);
}

// Updated playback to also trigger live FX
function startPlayback() {
  const playhead = document.getElementById("playhead");
  playhead.style.left = "0px";

  let maxEnd = 0;
  const blocks = Array.from(document.querySelectorAll(".fx-block")).map(b => ({
    fx: b.dataset.fx,
    delay: parseInt(b.style.left),
    duration: parseInt(b.style.width) * 10
  }));

  blocks.forEach(({ fx, delay, duration }) => {
    setTimeout(() => {
      triggerFXLive(fx, duration, 5);
    }, delay);

    const end = delay + duration;
    if (end > maxEnd) maxEnd = end;
  });

  playhead.style.transition = `left ${maxEnd / 1000}s linear`;
  playhead.style.left = maxEnd + "px";

  setTimeout(() => {
    playhead.style.transition = "none";
    playhead.style.left = "0px";
  }, maxEnd);
}
</script>
<div id="quickFxControls" style="margin-bottom: 0.5rem;">
<label style="display:block; font-weight:bold;">Duration: <span id="quickFxDurationLabel">1000</span>ms</label>
<input id="quickFxDuration" max="5000" min="100" step="100" style="width:100%;" type="range" value="1000"/>
<label style="display:block; font-weight:bold; margin-top:0.5rem;">Intensity: <span id="quickFxIntensityLabel">5</span></label>
<input id="quickFxIntensity" max="10" min="1" step="1" style="width:100%;" type="range" value="5"/>
<label style="display:block; margin-top:0.5rem;">
<input checked="" id="quickFxSoundToggle" type="checkbox"/> Enable FX Feedback Sound
      </label>
</div>
<div class="quick-fx-panel" id="quickFxPanel">
<button class="btn" onclick="sendCommand('TRIGGER:HELLFIRE')">Hellfire</button>
<button class="btn" onclick="sendCommand('TRIGGER:SHOCK')">Shock</button>
<button class="btn" onclick="sendCommand('TRIGGER:FLICKER')">Flicker</button>
<button class="btn" onclick="editQuickFx()">✏️</button></div>
<div id="fxEditorModal" style="display:none; position:fixed; top:10%; left:5%; width:90%; max-height:80vh; overflow-y:auto; background:#111; padding:1rem; border:2px solid var(--accent-color); border-radius:10px; z-index:2000;">
<h3 style="color:var(--accent-color); margin-bottom:0.5rem;">Edit Quick FX</h3>
<textarea id="quickFxInput" placeholder="Enter commands, one per line"></textarea>
<label for="presetFxList" style="color:var(--accent-color); font-weight:bold;">Load Built-in Preset:</label>
<select id="presetFxList" onchange="loadPresetFx(this.value)">
<option value="">-- Choose Preset --</option>
<option value="default">Default (Hellfire, Shock, Flicker)</option>
<option value="lighting">Lighting (PIXELS_ALL_ON, PIXELS_ALL_OFF)</option>
<option value="relays">Relays (RELAY1_ON, RELAY1_OFF, RELAY4_ON)</option>
<option value="audio">Audio (SOUND_PLAY_A, SOUND_PLAY_B, SOUND_STOP_ALL)</option>
</select>
<label for="customPresetName" style="color:var(--accent-color); font-weight:bold; margin-top:0.5rem;">Save as Custom Preset:</label>
<input id="customPresetName" placeholder="Preset Name"/>
<button class="btn" onclick="saveCustomPreset()">Save As Preset</button>
<label for="userPresetList" style="color:var(--accent-color); font-weight:bold;">Load Your Preset:</label>
<select id="userPresetList" onchange="loadCustomPreset(this.value)">
<option value="">-- Load Your Preset --</option>
</select>
<div style="margin-top:1rem; text-align:right;">
<button class="btn" onclick="saveQuickFx()">Save FX Panel</button>
<button class="btn" onclick="document.getElementById('fxEditorModal').style.display='none'">Cancel</button>
</div>
</div>
<div id="fxSettingsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:#111; border:none; border-radius:10px; padding:1rem; z-index:99999; width:300px; color:white; font-family:monospace;">
<h3 style="margin-top:0; color:#ff3333;">FX Settings</h3>
<label>Duration (ms):</label>
<input id="fxDuration" min="100" step="100" style="width:100%; margin-bottom:0.5rem;" type="number"/>
<label>Intensity:</label>
<input id="fxIntensity" max="10" min="1" style="width:100%; margin-bottom:1rem;" type="range" value="5"/>
<div style="text-align:right;">
<button class="btn" onclick="saveFxSettings()">Save</button>
<button class="btn" onclick="closeFxSettings()">Cancel</button>
</div>
</div>
<audio id="quickFxBeep" preload="auto" src="click.wav"></audio>
<!-- 🛠️ Command Builder Section -->
<section id="commandBuilder" class="panel" style="display:none;">
  <h2>🛠️ Command Builder</h2>
  <div>
    <h3>🎇 FX Command</h3>
    <label>FX ID: <select id="fxId"><option>FX_001</option><option>FX_002</option><option>FX_003</option></select></label>
    <label>START: <input id="fxStart" type="number" value="0"></label>
    <label>COUNT: <input id="fxCount" type="number" value="10"></label>
    <label>COLOR: <input id="fxColor" type="color" value="#ff0000"></label>
    <label>SPEED: <input id="fxSpeed" type="number" value="100"></label>
    <label>BRIGHT: <input id="fxBright" type="range" min="0" max="255" value="255"></label>
    <button onclick="generateFxCommand()">Generate</button>
    <textarea id="fxCommandPreview" readonly style="width:100%;"></textarea>
  </div>
  <hr/>
  <h3>🔌 Relay</h3>
  <input id="relayNum" type="number" min="1" max="12" value="1">
  <button onclick="generateRelay('ON')">ON</button>
  <button onclick="generateRelay('OFF')">OFF</button>
  <button onclick="setRelayAll('ON')">ALL ON</button>
  <button onclick="setRelayAll('OFF')">ALL OFF</button>
  <textarea id="relayCommandPreview" readonly style="width:100%;"></textarea>
  <hr/>
  <h3>🔊 MP3</h3>
  <select id="mp3Player"><option value="1">MP3_1</option><option value="2">MP3_2</option></select>
  <select id="mp3Track"><option>001</option><option>002</option><option>003</option></select>
  <button onclick="generateMP3()">PLAY</button>
  <button onclick="generateMP3Stop()">STOP</button>
  <textarea id="mp3CommandPreview" readonly style="width:100%;"></textarea>
  <hr/>
  <h3>🔧 System</h3>
  <input type="time" id="rtcTime" />
  <button onclick="setSysCommand('RESET_SYSTEM')">Reset</button>
  <button onclick="setSysCommand('EMERGENCY_STOP')">Emergency Stop</button>
  <button onclick="setSysCommand('REQUEST_STATUS')">Request Status</button>
  <button onclick="generateRtc()">RTC SYNC</button>
  <textarea id="sysCommandPreview" readonly style="width:100%;"></textarea>
  <hr/>
  <h3>🧲 Scene Buttons</h3>
  <div id="sceneBtns"></div>
  <textarea id="sceneCommandPreview" readonly style="width:100%;"></textarea>
</section>

<div id="customizer" class="panel" style="display:none;">
<button onclick="showPanel(\'main\')" style="margin:10px;">⬅ Back to Dashboard</button>
<div class="sidebar">
    <h2>Add/Edit FX</h2>
    <input type="text" id="fxName" placeholder="FX Name">
    <input type="text" id="fxCommand" placeholder="FX Command">
    <input type="color" id="fxColor" value="#5c5c5c">
    <button onclick="addFX()">Add FX</button>
    <button onclick="saveLayout()">💾 Save</button>
    <button onclick="exportLayout()">📤 Export</button>
    <input type="file" id="importFile" onchange="importLayout(event)" style="display:none">
    <button onclick="document.getElementById('importFile').click()">📥 Import</button>
  </div><div class="main" id="fxContainer">
    <h2>Live FX Buttons</h2>
  </div>
</div>

    <script>
    function showPanel(panelId) {
      const panels = document.querySelectorAll('.panel');
      panels.forEach(p => p.style.display = 'none');
      const active = document.getElementById(panelId);
      if (active) active.style.display = 'block';
    }
    </script>
    

<script>
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch((err) => {
      console.error(`Error attempting to enable fullscreen: ${err.message}`);
    });
  } else {
    document.exitFullscreen();
  }
}
</script>

</body>

<script>
firebase.auth().onAuthStateChanged(user => {
  const el = document.getElementById("firebase-user-info");
  if (el) el.innerHTML = user
    ? `<strong>Logged in as:</strong> ${user.email} <button onclick='firebase.auth().signOut()'>Logout</button>`
    : "<i>Not logged in</i>";
});

function loginEmail() {
  const email = prompt("Enter email:");
  const password = prompt("Enter password:");
  firebase.auth().signInWithEmailAndPassword(email, password).catch(e => alert("Login failed: " + e.message));
}
function loginGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).catch(e => alert("Google login failed: " + e.message));
}

// --- Command Builder Logic ---
function generateFxCommand() {
  const id = fxId.value, start = fxStart.value, count = fxCount.value,
        color = fxColor.value, speed = fxSpeed.value, bright = fxBright.value;
  const rgb = hexToRgb(color);
  fxCommandPreview.value = `${id}:START=${start};COUNT=${count};COLOR=${rgb};SPEED=${speed};BRIGHT=${bright}`;
}
function hexToRgb(hex) {
  const val = parseInt(hex.slice(1), 16);
  return [(val >> 16) & 255, (val >> 8) & 255, val & 255].join(",");
}
function generateRelay(state) {
  const num = relayNum.value;
  relayCommandPreview.value = `RELAY_${state}_${num}`;
}
function setRelayAll(state) {
  relayCommandPreview.value = `RELAY_ALL_${state}`;
}
function generateMP3() {
  mp3CommandPreview.value = `MP3_${mp3Player.value}_PLAY_${mp3Track.value}`;
}
function generateMP3Stop() {
  mp3CommandPreview.value = `MP3_${mp3Player.value}_STOP`;
}
function setSysCommand(cmd) {
  sysCommandPreview.value = cmd;
}
function generateRtc() {
  const time = rtcTime.value;
  if (time) sysCommandPreview.value = `RTC_SYNC:${time}`;
}
function generateSceneBtns() {
  const container = document.getElementById("sceneBtns");
  if (!container) return;
  for (let i = 0; i <= 9; i++) {
    const btn = document.createElement("button");
    btn.className = "btn"; btn.textContent = `SXBTN_${i}`;
    btn.onclick = () => sceneCommandPreview.value = `SXBTN_${i}`;
    container.appendChild(btn);
  }
}
document.addEventListener("DOMContentLoaded", generateSceneBtns);
</script>

</html>
